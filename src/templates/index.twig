{% extends "_layouts/cp" %}

{% set title = "Lottie Animator" %}

{% block actionButton %}
    {% if primaryVolume %}
        <form id="lottie-upload-form" enctype="multipart/form-data" style="display: inline-block;">
            <input type="file" id="lottie-file-input" accept=".json,.lottie" style="display: none;">
            <button type="button" id="lottie-upload-btn" class="btn submit add icon" data-icon="plus">
                {{ "Upload Lottie File"|t('craft-lottie') }}
            </button>
        </form>
    {% endif %}
{% endblock %}

{% block content %}
    <div class="lottie-manager">
        {% if not primaryVolume %}
            <div class="pane">
                <div class="warning">
                    <p><strong>{{ "No volume configured"|t('craft-lottie') }}</strong></p>
                    <p>{{ "Please configure a volume in"|t('craft-lottie') }} <a href="{{ url('craft-lottie/settings') }}">{{ "plugin settings"|t('craft-lottie') }}</a> {{ "to use the Lottie library."|t('craft-lottie') }}</p>
                </div>
            </div>
        {% endif %}


        {% if primaryVolume and lottieAssets|length > 0 %}
            <div class="lottie-list">
                <table class="data fullwidth">
                    <thead>
                        <tr>
                            <th>{{ "Filename"|t('craft-lottie') }}</th>
                            <th>{{ "Volume"|t('craft-lottie') }}</th>
                            <th>{{ "Date Created"|t('craft-lottie') }}</th>
                            <th>{{ "Size"|t('craft-lottie') }}</th>
                            <th class="thin">{{ "Actions"|t('craft-lottie') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for asset in lottieAssets %}
                            <tr data-asset-id="{{ asset.id }}">
                                <td>
                                    <a href="{{ url('craft-lottie/edit/' ~ asset.id) }}" class="lottie-asset-link">
                                        <strong>{{ asset.filename }}</strong>
                                    </a>
                                </td>
                                <td>{{ asset.volume.name }}</td>
                                <td>{{ asset.dateCreated|date('Y-m-d H:i') }}</td>
                                <td>{{ asset.size|filesize }}</td>
                                <td class="thin">
                                    <a href="{{ url('craft-lottie/edit/' ~ asset.id) }}" class="btn small">
                                        {{ "Edit"|t('craft-lottie') }}
                                    </a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% elseif primaryVolume %}
            <div class="zilch">
                <p>{{ "No Lottie files have been uploaded yet."|t('craft-lottie') }}</p>
            </div>
        {% endif %}
    </div>
{% endblock %}

{% css %}
.lottie-manager-header {
    margin-bottom: 30px;
}

.lottie-manager-header h1 {
    margin-bottom: 8px;
}

.lottie-manager-header p {
    color: #596673;
    font-size: 14px;
}


.lottie-asset-link {
    text-decoration: none;
}

.lottie-asset-link:hover {
    text-decoration: underline;
}

.warning {
    padding: 16px;
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 4px;
    color: #856404;
}

.warning p {
    margin: 0 0 8px 0;
}

.warning p:last-child {
    margin-bottom: 0;
}

.warning a {
    color: #856404;
    text-decoration: underline;
}
{% endcss %}

{% js %}
{% if primaryVolume %}
(function() {
    const uploadBtn = document.getElementById('lottie-upload-btn');
    const fileInput = document.getElementById('lottie-file-input');
    
    if (!uploadBtn || !fileInput) return;
    
    const originalText = uploadBtn.textContent.trim();
    
    uploadBtn.addEventListener('click', function() {
        fileInput.click();
    });
    
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Validate file extension
        const extension = file.name.toLowerCase().split('.').pop();
        if (extension !== 'json' && extension !== 'lottie') {
            Craft.cp.displayError('{{ "Only JSON and .lottie files are allowed."|t('craft-lottie') }}');
            fileInput.value = '';
            return;
        }
        
        // Show loading state
        uploadBtn.disabled = true;
        uploadBtn.textContent = '{{ "Uploading..."|t('craft-lottie') }}';
        
        // Create FormData
        const formData = new FormData();
        formData.append('file', file);
        formData.append('{{ craft.app.request.csrfParam }}', '{{ craft.app.request.csrfToken }}');
        
        // Upload file
        fetch('/actions/craft-lottie/default/upload', {
            method: 'POST',
            body: formData,
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Craft.cp.displayNotice('{{ "File uploaded successfully."|t('craft-lottie') }}');
                // Reload page to show new file
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            } else {
                Craft.cp.displayError(data.error || '{{ "Upload failed."|t('craft-lottie') }}');
                uploadBtn.disabled = false;
                uploadBtn.textContent = originalText;
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            Craft.cp.displayError('{{ "Upload failed. Please try again."|t('craft-lottie') }}');
            uploadBtn.disabled = false;
            uploadBtn.textContent = originalText;
        });
        
        // Reset file input
        fileInput.value = '';
    });
})();
{% endif %}
{% endjs %}
