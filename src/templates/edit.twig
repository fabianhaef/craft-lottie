{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set title = "Edit: " ~ asset.filename %}

{% block content %}
    <div class="lottie-editor">
        <div class="lottie-editor-header">
            <div class="flex">
                <div class="flex-grow">
                    <h1>{{ asset.filename }}</h1>
                    <p class="light">{{ asset.volume.name }} • {{ asset.size|filesize }}</p>
                </div>
                <div class="flex gap">
                    <a href="{{ url('craft-lottie') }}" class="btn">{{ "← Back to Library"|t('craft-lottie') }}</a>
                    <button id="save-btn" class="btn submit" disabled>{{ "Save Changes"|t('craft-lottie') }}</button>
                    <button id="save-as-btn" class="btn">{{ "Save as Copy"|t('craft-lottie') }}</button>
                </div>
            </div>
        </div>

        <div class="lottie-editor-content">
            <div class="lottie-editor-grid">
                <!-- Preview Section -->
                <div class="lottie-preview-pane">
                    <div class="pane">
                        <h2>{{ "Preview"|t('craft-lottie') }}</h2>
                        <div id="lottie-preview" class="lottie-preview-container" data-asset-id="{{ asset.id }}">
                            <div class="lottie-loading">
                                <div class="spinner"></div>
                                <p>{{ "Loading animation..."|t('craft-lottie') }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Controls Section -->
                <div class="lottie-controls-pane">
                    <div class="pane">
                        <h2>{{ "Animation Settings"|t('craft-lottie') }}</h2>
                        
                        {% set speedLabel = "Playback Speed"|t('craft-lottie') %}
                        {% set speedInstructions = "Adjust the animation playback speed (0.1x to 5.0x)"|t('craft-lottie') %}
                        {{ forms.field({
                            label: speedLabel,
                            instructions: speedInstructions,
                            id: 'speed-field'
                        }, '<div class="lottie-speed-control-wrapper">
                            <input type="range" id="speed-control" min="0.1" max="5" step="0.1" value="1.0" class="lottie-speed-slider">
                            <div class="lottie-speed-display">
                                <input type="number" id="speed-input" min="0.1" max="5" step="0.1" value="1.0" class="lottie-speed-input">
                                <span class="lottie-speed-unit">x</span>
                            </div>
                        </div>') }}

                        {% set bgColorLabel = "Background Color"|t('craft-lottie') %}
                        {% set bgColorInstructions = "Set a background color for the animation preview"|t('craft-lottie') %}
                        {% set clearLabel = "Clear"|t('craft-lottie') %}
                        {{ forms.field({
                            label: bgColorLabel,
                            instructions: bgColorInstructions,
                            id: 'background-color-field'
                        }, '<div class="lottie-background-control-wrapper">
                            <input type="color" id="background-color" value="#ffffff" class="lottie-color-input">
                            <button type="button" id="clear-background" class="btn small">' ~ clearLabel ~ '</button>
                        </div>') }}

                        {% set colorsLabel = "Edit Colors"|t('craft-lottie') %}
                        {% set colorsInstructions = "Modify colors in the animation. Changes are applied in real-time."|t('craft-lottie') %}
                        {% set extractingColors = "Extracting colors..."|t('craft-lottie') %}
                        {{ forms.field({
                            label: colorsLabel,
                            instructions: colorsInstructions,
                            id: 'colors-field'
                        }, '<div id="color-picker-container" class="lottie-color-picker-container">
                            <div class="lottie-colors-loading">' ~ extractingColors ~ '</div>
                        </div>') }}

                        {% set textLabel = "Edit Text"|t('craft-lottie') %}
                        {% set textInstructions = "Modify text content in the animation. Changes are applied in real-time."|t('craft-lottie') %}
                        {% set extractingText = "Extracting text layers..."|t('craft-lottie') %}
                        {{ forms.field({
                            label: textLabel,
                            instructions: textInstructions,
                            id: 'text-editor-field'
                        }, '<div id="text-editor-container" class="lottie-text-editor-container">
                            <div class="lottie-text-loading">' ~ extractingText ~ '</div>
                        </div>') }}

                        {% set layersLabel = "Layer Management"|t('craft-lottie') %}
                        {% set layersInstructions = "Show or hide layers in the animation. Changes are applied in real-time."|t('craft-lottie') %}
                        {% set extractingLayers = "Extracting layers..."|t('craft-lottie') %}
                        {{ forms.field({
                            label: layersLabel,
                            instructions: layersInstructions,
                            id: 'layers-field'
                        }, '<div id="layers-container" class="lottie-layers-container">
                            <div class="lottie-layers-loading">' ~ extractingLayers ~ '</div>
                        </div>') }}

                        <hr>

                        {% set interactionsLabel = "Interactions"|t('craft-lottie') %}
                        {% set interactionsInstructions = "Configure interactive behaviors for the animation (scroll triggers, click actions, hover effects, URL links)."|t('craft-lottie') %}
                        {% set addInteractionLabel = "Add Interaction"|t('craft-lottie') %}
                        {% set scrollTriggerLabel = "Scroll Trigger"|t('craft-lottie') %}
                        {% set clickActionLabel = "Click Action"|t('craft-lottie') %}
                        {% set hoverEffectLabel = "Hover Effect"|t('craft-lottie') %}
                        {% set urlLinkLabel = "URL Link"|t('craft-lottie') %}
                        {{ forms.field({
                            label: interactionsLabel,
                            instructions: interactionsInstructions,
                            id: 'interactions-field'
                        }, '<div id="interactions-container" class="lottie-interactions-container">
                            <div class="btn menubtn" id="add-interaction-btn" data-icon="plus">' ~ addInteractionLabel ~ '</div>
                            <div class="menu" id="add-interaction-menu">
                                <ul class="padded">
                                    <li><a data-type="scroll" href="javascript:void(0)"><span class="icon" data-icon="arrows"></span> ' ~ scrollTriggerLabel ~ '</a></li>
                                    <li><a data-type="click" href="javascript:void(0)"><span class="icon" data-icon="pointer"></span> ' ~ clickActionLabel ~ '</a></li>
                                    <li><a data-type="hover" href="javascript:void(0)"><span class="icon" data-icon="cursor"></span> ' ~ hoverEffectLabel ~ '</a></li>
                                    <li><a data-type="url" href="javascript:void(0)"><span class="icon" data-icon="world"></span> ' ~ urlLinkLabel ~ '</a></li>
                                </ul>
                            </div>
                        </div>') }}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% css %}
.lottie-editor-header {
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--hairline-color);
}

.lottie-editor-header h1 {
    margin-bottom: 4px;
    font-size: 24px;
}

.lottie-editor-header .flex {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.lottie-editor-header .flex.gap {
    gap: 12px;
}

.lottie-editor-content {
    max-width: 1400px;
}

.lottie-editor-grid {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 24px;
}

.lottie-preview-pane .pane,
.lottie-controls-pane .pane {
    padding: 24px;
    background: var(--pane-bg);
    border-radius: var(--pane-border-radius);
    box-shadow: var(--pane-shadow);
}

.lottie-preview-pane h2,
.lottie-controls-pane h2 {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 16px;
    color: var(--text-color);
}

.lottie-preview-container {
    width: 100%;
    min-height: 400px;
    max-height: 600px;
    background: var(--gray-050);
    border: 1px solid var(--hairline-color);
    border-radius: var(--small-border-radius);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
}

.lottie-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    color: var(--light-text-color);
}

.lottie-loading .spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--gray-200);
    border-top-color: var(--link-color);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.lottie-speed-control-wrapper {
    display: flex;
    align-items: center;
    gap: 16px;
}

.lottie-speed-slider {
    flex: 1;
    height: 6px;
    border-radius: 3px;
    background: var(--gray-200);
    outline: none;
    -webkit-appearance: none;
    cursor: pointer;
}

.lottie-speed-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--link-color);
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: transform 0.1s;
}

.lottie-speed-slider::-webkit-slider-thumb:hover {
    transform: scale(1.1);
}

.lottie-speed-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--link-color);
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: transform 0.1s;
}

.lottie-speed-slider::-moz-range-thumb:hover {
    transform: scale(1.1);
}

.lottie-speed-display {
    display: flex;
    align-items: center;
    gap: 4px;
    min-width: 80px;
}

.lottie-speed-input {
    width: 60px;
    padding: 6px 8px;
    border: 1px solid var(--input-border-color);
    border-radius: var(--small-border-radius);
    background: var(--input-bg);
    font-size: 14px;
    text-align: center;
}

.lottie-speed-unit {
    font-size: 14px;
    color: var(--light-text-color);
    font-weight: 500;
}

.lottie-background-control-wrapper {
    display: flex;
    align-items: center;
    gap: 12px;
}

.lottie-color-input {
    width: 60px;
    height: 40px;
    border: 1px solid var(--input-border-color);
    border-radius: var(--small-border-radius);
    cursor: pointer;
    padding: 2px;
    background: var(--input-bg);
}

.lottie-color-picker-container {
    margin-top: 8px;
}

.lottie-palette-section {
    margin-bottom: 20px;
}

.lottie-palette-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--medium-text-color);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.lottie-palette-colors {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 12px;
}

.lottie-palette-swatch {
    width: 40px;
    height: 40px;
    border: 2px solid var(--hairline-color);
    border-radius: var(--small-border-radius);
    cursor: pointer;
    padding: 0;
    background: none;
    transition: all 0.2s;
    position: relative;
}

.lottie-palette-swatch:hover {
    border-color: var(--link-color);
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.lottie-palette-swatch:active {
    transform: scale(0.95);
}

.lottie-colors-separator {
    height: 1px;
    background: var(--hairline-color);
    margin: 16px 0;
}

.lottie-colors-extracted {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 12px;
}

.lottie-color-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 12px;
    background: var(--gray-050);
    border: 1px solid var(--hairline-color);
    border-radius: var(--small-border-radius);
    transition: all 0.2s;
}

.lottie-color-item:hover {
    border-color: var(--link-color);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.lottie-color-swatch {
    width: 100%;
    height: 40px;
    border-radius: var(--small-border-radius);
    border: 1px solid var(--hairline-color);
    cursor: pointer;
    padding: 2px;
    background: white;
}

.lottie-color-label {
    font-size: 12px;
    color: var(--light-text-color);
    text-align: center;
    word-break: break-all;
}

.lottie-colors-loading {
    padding: 20px;
    text-align: center;
    color: var(--light-text-color);
    font-size: 14px;
}

.lottie-colors-empty {
    padding: 20px;
    text-align: center;
    color: var(--light-text-color);
    font-size: 14px;
    font-style: italic;
}

.lottie-text-editor-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 8px;
}

.lottie-text-loading {
    padding: 20px;
    text-align: center;
    color: var(--light-text-color);
    font-size: 14px;
}

.lottie-text-empty {
    padding: 20px;
    text-align: center;
    color: var(--light-text-color);
    font-size: 14px;
    font-style: italic;
}

.lottie-text-item {
    padding: 12px;
    background: var(--gray-050);
    border: 1px solid var(--hairline-color);
    border-radius: var(--small-border-radius);
    transition: all 0.2s;
}

.lottie-text-item:hover {
    border-color: var(--link-color);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.lottie-text-header {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 8px;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--hairline-color);
}

.lottie-text-input-wrapper {
    margin-top: 8px;
}

.lottie-text-input-wrapper:first-of-type {
    margin-top: 0;
}

.lottie-text-label {
    display: block;
    font-size: 12px;
    color: var(--light-text-color);
    margin-bottom: 4px;
}

.lottie-text-input {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid var(--input-border-color);
    border-radius: var(--small-border-radius);
    background: var(--input-bg);
    font-size: 14px;
    transition: border-color 0.2s;
}

.lottie-text-input:focus {
    outline: none;
    border-color: var(--link-color);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.lottie-layers-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 8px;
    max-height: 400px;
    overflow-y: auto;
}

.lottie-layers-loading {
    padding: 20px;
    text-align: center;
    color: var(--light-text-color);
    font-size: 14px;
}

.lottie-layers-empty {
    padding: 20px;
    text-align: center;
    color: var(--light-text-color);
    font-size: 14px;
    font-style: italic;
}

.lottie-layer-item {
    padding: 10px 12px;
    background: var(--gray-050);
    border: 1px solid var(--hairline-color);
    border-radius: var(--small-border-radius);
    transition: all 0.2s;
}

.lottie-layer-item:hover {
    border-color: var(--link-color);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.lottie-layer-toggle {
    display: flex;
    align-items: center;
    cursor: pointer;
    user-select: none;
}

.lottie-layer-toggle-label {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
}

.lottie-layer-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
    flex-shrink: 0;
}

.lottie-layer-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.lottie-layer-name {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-color);
}

.lottie-layer-type {
    font-size: 11px;
    color: var(--light-text-color);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.lottie-layer-item:has(.lottie-layer-checkbox:not(:checked)) {
    opacity: 0.6;
}

.lottie-layer-item:has(.lottie-layer-checkbox:not(:checked)) .lottie-layer-name {
    text-decoration: line-through;
}

.lottie-error {
    padding: 24px;
    text-align: center;
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: var(--small-border-radius);
}

.lottie-error > div:first-child {
    color: #cf1124;
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 8px;
}

.lottie-error > div:nth-child(2) {
    color: #6b7280;
    font-size: 14px;
    margin-bottom: 16px;
}

.lottie-error > div:last-child {
    font-size: 12px;
    color: #9ca3af;
}

.lottie-interactions-container {
    margin-top: 8px;
    position: relative;
}

#add-interaction-btn {
    margin-bottom: 12px;
}

.lottie-interaction-item {
    padding: 12px;
    background: var(--gray-050);
    border: 1px solid var(--hairline-color);
    border-radius: var(--small-border-radius);
    margin-bottom: 12px;
    transition: all 0.2s;
}

.lottie-interaction-item:hover {
    border-color: var(--link-color);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.lottie-interaction-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
}

.lottie-interaction-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-color);
}

.lottie-interaction-remove {
    flex-shrink: 0;
}

.lottie-interaction-fields {
    display: grid;
    gap: 12px;
}

.lottie-interaction-field {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.lottie-interaction-field label {
    font-size: 12px;
    color: var(--light-text-color);
    font-weight: 500;
}

.lottie-interaction-field select,
.lottie-interaction-field input {
    padding: 6px 8px;
    border: 1px solid var(--input-border-color);
    border-radius: var(--small-border-radius);
    background: var(--input-bg);
    font-size: 14px;
}

.lottie-interaction-field input[type="checkbox"] {
    width: auto;
    margin-right: 8px;
}

.lottie-interaction-field-row {
    display: flex;
    align-items: center;
    gap: 8px;
}

@media (max-width: 1200px) {
    .lottie-editor-grid {
        grid-template-columns: 1fr;
    }
    
    .lottie-controls-pane {
        order: -1;
    }
}
{% endcss %}

{% js %}
// Load lottie-web library dynamically
// Using version 5.9.6 which is more stable with minimal text layer structures
const lottieScript = document.createElement('script');
lottieScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.9.6/lottie.min.js';
lottieScript.onload = function() {
    initLottieEditor();
};
lottieScript.onerror = function() {
    const previewContainer = document.getElementById('lottie-preview');
    if (previewContainer) {
        previewContainer.innerHTML = '<div class="lottie-loading"><p style="color: #cf1124;">Failed to load Lottie library. Please refresh the page.</p></div>';
    }
};
document.head.appendChild(lottieScript);

function initLottieEditor() {
    const previewContainer = document.getElementById('lottie-preview');
    if (!previewContainer) return;

    const assetId = previewContainer.getAttribute('data-asset-id');
    if (!assetId) {
        previewContainer.innerHTML = '<div class="lottie-loading"><p style="color: #cf1124;">Invalid asset ID</p></div>';
        return;
    }

    // Initialize the main editor
    const editor = new LottieEditorMain({
        assetId: assetId,
        brandPalette: {{ brandPalette|default([])|json_encode|raw }},
        csrfToken: '{{ craft.app.request.csrfToken }}',
        csrfParam: '{{ craft.app.request.csrfParam }}',
        translations: {
            saveChanges: {{ "Save Changes"|t('craft-lottie')|json_encode|raw }},
            saving: {{ "Saving..."|t('craft-lottie')|json_encode|raw }},
            saved: {{ "Saved!"|t('craft-lottie')|json_encode|raw }},
            saveAsCopy: {{ "Save as Copy"|t('craft-lottie')|json_encode|raw }},
            savedSuccessfully: {{ "Animation saved successfully"|t('craft-lottie')|json_encode|raw }},
            savedAsNewAsset: {{ "Animation saved as new asset successfully"|t('craft-lottie')|json_encode|raw }},
            failedToSave: {{ "Failed to save"|t('craft-lottie')|json_encode|raw }},
            failedToSaveAnimation: {{ "Failed to save animation:"|t('craft-lottie')|json_encode|raw }},
            failedToSaveAsNewAsset: {{ "Failed to save as new asset:"|t('craft-lottie')|json_encode|raw }},
            brandPalette: {{ "Brand Palette"|t('craft-lottie')|json_encode|raw }},
            animationColors: {{ "Animation Colors"|t('craft-lottie')|json_encode|raw }},
            noColorsFound: {{ "No editable colors found in this animation"|t('craft-lottie')|json_encode|raw }},
            noColorsToReplace: {{ "No colors found in animation to replace"|t('craft-lottie')|json_encode|raw }},
            noTextLayers: {{ "No editable text layers found in this animation"|t('craft-lottie')|json_encode|raw }},
            noLayers: {{ "No layers found in this animation"|t('craft-lottie')|json_encode|raw }},
            text: {{ "Text"|t('craft-lottie')|json_encode|raw }},
            textContent: {{ "Text Content"|t('craft-lottie')|json_encode|raw }},
            keyframe: {{ "Keyframe"|t('craft-lottie')|json_encode|raw }},
            remove: {{ "Remove"|t('craft-lottie')|json_encode|raw }},
            enabled: {{ "Enabled"|t('craft-lottie')|json_encode|raw }},
            trigger: {{ "Trigger"|t('craft-lottie')|json_encode|raw }},
            offset: {{ "Offset"|t('craft-lottie')|json_encode|raw }},
            direction: {{ "Direction"|t('craft-lottie')|json_encode|raw }},
            action: {{ "Action"|t('craft-lottie')|json_encode|raw }},
            onEnter: {{ "On Enter"|t('craft-lottie')|json_encode|raw }},
            onLeave: {{ "On Leave"|t('craft-lottie')|json_encode|raw }},
            url: {{ "URL"|t('craft-lottie')|json_encode|raw }},
            target: {{ "Target"|t('craft-lottie')|json_encode|raw }},
            layerName: {{ "Layer Name"|t('craft-lottie')|json_encode|raw }},
            layerNamePlaceholder: {{ "Optional: specific layer to make clickable"|t('craft-lottie')|json_encode|raw }},
            scrollTrigger: {{ "Scroll Trigger"|t('craft-lottie')|json_encode|raw }},
            clickAction: {{ "Click Action"|t('craft-lottie')|json_encode|raw }},
            hoverEffect: {{ "Hover Effect"|t('craft-lottie')|json_encode|raw }},
            urlLink: {{ "URL Link"|t('craft-lottie')|json_encode|raw }}
        }
    });

    editor.init();
}
{% endjs %}
